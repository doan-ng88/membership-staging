<!-- Generated by Cursor -->
<template>
  <div class="bg-white p-6 rounded-lg shadow mb-6">
    <a-form layout="vertical" :model="filterForm">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Date Join Member Tab -->
        <template v-if="tab === 'date-join-member'">
          <!-- Date Join Member Range -->
          <a-form-item :label="t('profileManagement.filter.dateJoinMember')">
            <a-range-picker
              v-model:value="filterForm.registeredTimeRange"
              style="width: 100%"
            />
          </a-form-item>

          <!-- Platform Website -->
          <a-form-item :label="t('profileManagement.filter.platformWebsite')">
            <a-select v-model:value="filterForm.websiteId">
              <a-select-option value="">{{ t('profileManagement.filter.allWebsites') }}</a-select-option>
              <a-select-option v-for="website in websites" 
                              :key="website.websiteId" 
                              :value="website.websiteId">
                {{ website.name }}
              </a-select-option>
            </a-select>
          </a-form-item>

          <!-- Member Level -->
          <a-form-item v-if="!props.hideMemberLevel" :label="t('profileManagement.filter.memberLevel')">
            <a-select v-model:value="filterForm.levelId">
              <a-select-option value="">{{ t('profileManagement.filter.allLevels') }}</a-select-option>
              <a-select-option v-for="level in memberLevels" :key="level.id" :value="level.id">
                {{ level.levelName }}
              </a-select-option>
            </a-select>
          </a-form-item>
        </template>

        <!-- Date of Birth Tab -->
        <template v-else-if="tab === 'date-of-birth'">
          <!-- Date of Birth Range -->
          <a-form-item :label="t('profileManagement.filter.dateOfBirth')">
            <a-month-picker
              v-model:value="filterForm.birthdayMonth"
              format="MM"
              style="width: 100%"
              :placeholder="t('profileManagement.filter.selectMonth')"
            />
          </a-form-item>

          <!-- Platform Website -->
          <a-form-item :label="t('profileManagement.filter.platformWebsite')">
            <a-select v-model:value="filterForm.websiteId">
              <a-select-option value="">{{ t('profileManagement.filter.allWebsites') }}</a-select-option>
              <a-select-option v-for="website in websites" 
                              :key="website.websiteId" 
                              :value="website.websiteId">
                {{ website.name }}
              </a-select-option>
            </a-select>
          </a-form-item>
        </template>

        <!-- Order Date Tab -->
        <template v-else-if="tab === 'order-date'">
          <a-form-item :label="t('profileManagement.filter.orderDate')">
            <a-range-picker
              v-model:value="filterForm.orderDateRange"
              style="width: 100%"
              :disabled-date="disabledDate"
            />
          </a-form-item>

          <a-form-item :label="t('profileManagement.filter.platformWebsite')">
            <a-select v-model:value="filterForm.websiteId">
              <a-select-option value="">{{ t('profileManagement.filter.allWebsites') }}</a-select-option>
              <a-select-option 
                v-for="website in websites" 
                :key="website.websiteId" 
                :value="website.websiteId"
              >
                {{ website.name }}
              </a-select-option>
            </a-select>
          </a-form-item>
        </template>
      </div>

      <!-- Action Buttons -->
      <div class="flex justify-end space-x-4">
        <a-button type="primary" @click="handleSearch">{{ t('profileManagement.filter.filterButtonText') }}</a-button>
        <a-button @click="handleReset">{{ t('profileManagement.filter.reset') }}</a-button>
      </div>
    </a-form>
  </div>
</template>

<script lang="ts">
import { defineComponent } from 'vue'

export default defineComponent({
  name: 'SearchFilters',
  props: {
    tab: {
      type: String as () => TabType,
      required: true
    },
    hideOrderPoint: {
      type: Boolean,
      default: false
    },
    hideLevelUpCondition: {
      type: Boolean,
      default: false
    },
    hideMemberLevel: {
      type: Boolean,
      default: false
    }
  },
  emits: ['filter', 'reset']
})
</script>

<script setup lang="ts">
import { ref, reactive, watch } from 'vue'
import { useI18nGlobal } from '@/i18n'
import type { Dayjs } from 'dayjs'
import type { TabType } from '@/types/profile'
import { websites } from '@/api/types/website'
import { memberLevels, getLevelNameById } from '@/api/types/member'
import dayjs from 'dayjs'

const { t } = useI18nGlobal()

const props = defineProps<{
  tab: TabType,
  hideOrderPoint: boolean,
  hideLevelUpCondition: boolean,
  hideMemberLevel: boolean
}>()

const emit = defineEmits<{
  (e: 'filter', params: Array<{key: string, value: any}>): void
  (e: 'reset'): void
}>()

interface FilterForm {
  registeredTimeRange: [Dayjs, Dayjs] | null
  birthdayMonth: Dayjs | null
  websiteId: string | number
  levelId: string | number
  orderDateRange: [Dayjs, Dayjs] | null
}

const filterForm = reactive<FilterForm>({
  registeredTimeRange: null,
  birthdayMonth: null,
  websiteId: '',
  levelId: '',
  orderDateRange: null
})

const handleSearch = () => {
  const params: Array<{key: string, value: any}> = []
  if (props.tab === 'date-join-member') {
    // 1. Date Join Member Range
    if (filterForm.registeredTimeRange?.[0] && filterForm.registeredTimeRange?.[1]) {
      const startDate = filterForm.registeredTimeRange[0]
      const endDate = filterForm.registeredTimeRange[1]
      
      if (startDate.isValid() && endDate.isValid()) {
        params.push({ 
          key: 'registeredTimeFrom', 
          value: startDate.format('YYYY-MM-DD') 
        })
        params.push({ 
          key: 'registeredTimeTo', 
          value: endDate.format('YYYY-MM-DD') 
        })
      }
    }
    // 2. Website Filter
    if (filterForm.websiteId) {
      params.push({ 
        key: 'websiteId', 
        value: filterForm.websiteId 
      })
    }
    // 3. Member Level
    if (!props.hideMemberLevel && filterForm.levelId) {
      const levelName = getLevelNameById(Number(filterForm.levelId))
      if (levelName) {
        params.push({ 
          key: 'levelName', 
          value: levelName.trim()
        })
      }
    }
  } else if (props.tab === 'date-of-birth') {
    if (filterForm.birthdayMonth) {
      params.push({ 
        key: 'birthdayMonth',
        value: filterForm.birthdayMonth.format('M')
      })
    }

    if (filterForm.websiteId) {
      params.push({ 
        key: 'websiteId', 
        value: filterForm.websiteId.toString()
      })
    }
  } else if (props.tab === 'order-date') {
    if (filterForm.orderDateRange?.[0] && filterForm.orderDateRange?.[1]) {
      const startDate = filterForm.orderDateRange[0]
      const endDate = filterForm.orderDateRange[1]
      
      if (startDate.isValid() && endDate.isValid()) {
        params.push({ 
          key: 'orderDateFrom', 
          value: startDate.format('YYYY-MM-DD') 
        })
        params.push({ 
          key: 'orderDateTo', 
          value: endDate.format('YYYY-MM-DD') 
        })
      }
    }
    if (filterForm.websiteId) {
      params.push({ 
        key: 'websiteId', 
        value: filterForm.websiteId.toString()
      })
    }
  }
  console.log('Search params:', params) // Debug params
  if (params.length > 0) {
    emit('filter', params)
  } else {
    emit('reset')
  }
}

const handleReset = () => {
  // Emit reset event
  emit('reset');
  if (props.tab === 'order-date') {
    filterForm.orderDateRange = null
    filterForm.websiteId = ''
  } else {
    Object.assign(filterForm, {
      registeredTimeRange: null,
      birthdayMonth: null,
      websiteId: '',
      levelId: '',
      
    })
  }
  emit('reset')
}

// Thêm watch để reset form khi chuyển tab
// Watch for tab changes
watch(() => props.tab, (newTab: TabType) => {
  switch(newTab) {
    case 'date-of-birth':
      filterForm.birthdayMonth = null
      filterForm.websiteId = ''
      break
      
    case 'order-date':
      filterForm.orderDateRange = null
      filterForm.websiteId = ''
      break
      
    case 'date-join-member':
      filterForm.registeredTimeRange = null
      filterForm.websiteId = ''
      filterForm.levelId = ''
      break
  }
  
  emit('reset')
}, { immediate: true });

// Thêm hàm disabledDate
const disabledDate = (current: Dayjs) => {
  return current && current > dayjs().endOf('day')
}
</script>