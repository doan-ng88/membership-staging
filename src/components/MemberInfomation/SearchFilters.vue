<!-- Generated by Cursor -->
<template>
  <div class="bg-white p-6 rounded-lg shadow-md mb-6">
    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
      <!-- Date Range Picker for Date Join Member -->
      <template v-if="tab === 'date-join-member'">
        <div>
          <label class="block text-gray-700">Date Join Member</label>
          <a-form-item
          :rules="[{ required: true, message: 'Vui lòng chọn thời gian tham gia' }]"
          class="flex-1"
        >
          <a-range-picker
            v-model:value="dateRange"
            format="YYYY-MM-DD"
            :placeholder="['Start date', 'End date']"
            style="width: 100%; height: 40px;"
            :disabled-date="disabledDate"
            @change="onDateRangeChange"
          />
        </a-form-item>
        </div>
      </template>

      <!-- Month Selection for Date of Birth -->
      <template v-if="tab === 'date-of-birth'">
        <div>
          <label class="block text-gray-700">Select Birthday Month</label>
          <select 
            v-model="filters.birthMonth"
            class="w-full p-2 border rounded-lg"
          >
            <option v-for="month in months" :key="month.value" :value="month.value">
              {{ month.label }}
            </option>
          </select>
        </div>
      </template>
      
      <!-- Platform Website Filter -->
      <div>
        <label class="block text-gray-700 mb-2">Platform Website</label>
        <a-select
          v-model:value="filters.websiteId"
          style="width: 100%"
          placeholder="Select Platform"
          allow-clear
          @change="handleWebsiteChange"
        >
          <a-select-option value="">All Platforms</a-select-option>
          <a-select-option 
            v-for="website in websites" 
            :key="website.websiteId" 
            :value="website.websiteId"
          >
            {{ website.name }}
          </a-select-option>
        </a-select>
      </div>

      <!-- Member Level Filter -->
      <template v-if="tab === 'date-join-member'">
        <div>
          <label class="block text-gray-700">Member Level</label>
          <select 
            v-model="filters.levelName"
            class="w-full p-2 border rounded-lg"
            @change="handleFilter"
          >
            <option value="">All Levels</option>
            <option 
              v-for="level in memberLevels" 
              :key="level.levelName"
              :value="level.levelName"
            >
              {{ level.levelName }}
            </option>
          </select>
        </div>
      </template>

      <!-- Additional filters only for Date Join Member tab -->
      <!-- <template v-if="tab === 'date-join-member'">
        <div>
          <label class="block text-gray-700">Member Downgrade Month</label>
          <select 
            v-model="filters.memberDowngradeMonth"
            class="w-full p-2 border rounded-lg"
          >
            <option value="">Select month</option>
            <option v-for="month in months" :key="month.value" :value="month.value">
              {{ month.label }}
            </option>
          </select>
        </div>
      </template> -->
    </div>

    <div class="flex justify-end gap-4 mt-4">
      <button 
        @click="handleFilter"
        class="bg-blue-600 text-white py-2 px-4 rounded-lg"
      >
        Filter
      </button>
      <button 
        @click="handleReset"
        class="bg-gray-500 text-white py-2 px-4 rounded-lg"
      >
        Reset
      </button>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, computed, watch } from 'vue'
import { websites, type Website } from '@/api/types/website'
import type { TabType } from '@/types/profile'
import { membershipAPI } from '@/api/services/membershipApi'
import dayjs from 'dayjs'

// Props & Emits
defineProps<{
  tab: TabType
}>()

const emit = defineEmits<{
  (e: 'filter', params: any): void
  (e: 'reset'): void
}>()

// State
const dateRange = ref<[dayjs.Dayjs, dayjs.Dayjs] | null>(null)

interface Member {
  levelName: string;
  // other properties...
}

// Thêm type cho memberLevels ref
const memberLevels = ref<Member[]>([])

const filters = ref({
  websiteId: '',
  levelName: '',
  // memberDowngradeMonth: undefined,
  birthMonth: undefined
})
const loading = ref(false)

// Define months array
const months = ref(Array.from({ length: 12 }, (_, i) => ({
  value: i + 1,
  label: new Date(2000, i, 1).toLocaleString('default', { month: 'long' })
})))

// Methods
const handleWebsiteChange = (websiteId: number | '') => {
  // Chỉ cập nhật state, không gọi handleFilter nữa
  filters.value.levelName = ''
  filters.value.websiteId = websiteId
}

const onDateRangeChange = (dates: [dayjs.Dayjs, dayjs.Dayjs] | null) => {
  // Chỉ cập nhật dateRange, không emit filter
  dateRange.value = dates
}

const handleFilter = () => {
  const searchParams = []
  
  // Xử lý date range
  if (dateRange.value) {
    const [startDate, endDate] = dateRange.value
    if (startDate && endDate) {
      searchParams.push(
        {
          key: 'registeredTimeFrom',
          value: startDate.format('YYYY-MM-DD')
        },
        {
          key: 'registeredTimeTo',
          value: endDate.format('YYYY-MM-DD')
        }
      )
    }
  }

  // Xử lý website
  if (filters.value.websiteId) {
    searchParams.push({
      key: 'websiteId',
      value: filters.value.websiteId
    })
  }

  // Xử lý level
  if (filters.value.levelName) {
    searchParams.push({
      key: 'levelName',
      value: filters.value.levelName
    })
  }

  // Xử lý birth month
  if (filters.value.birthMonth) {
    searchParams.push({
      key: 'birthMonth',
      value: filters.value.birthMonth
    })
  }

  // Xử lý member downgrade month
  // if (filters.value.memberDowngradeMonth) {
  //   searchParams.push({
  //     key: 'memberDowngradeMonth',
  //     value: filters.value.memberDowngradeMonth
  //   })
  // }

  // Chỉ emit khi nhấn nút Filter
  emit('filter', searchParams)
}

// Reset function
const handleReset = () => {
  filters.value = {
    websiteId: '',
    levelName: '',
    // memberDowngradeMonth: undefined,
    birthMonth: undefined
  }
  dateRange.value = null
  emit('reset')
}

// Sửa lại hàm extractUniqueLevels
const extractUniqueLevels = (members: any[]): MemberLevel[] => {
  const uniqueLevels = new Map<number, MemberLevel>()
  
  members.forEach(member => {
    if (member.levelId && member.levelName) {
      uniqueLevels.set(member.levelId, {
        levelId: member.levelId,
        Name: member.levelName  // Map levelName từ API thành Name cho template
      })
    }
  })
  
  return Array.from(uniqueLevels.values())
}

// Sửa lại cách load data
onMounted(async () => {
  try {
    loading.value = true
    const response = await membershipAPI.getList(
      'MembershipsWebsitesId', 
      'ASC', 
      100,
      1, 
      []
    )
    
    console.log('API Response:', response) // Log toàn bộ response
    
    if (response.data?.data) {
      console.log('Response data:', response.data.data) // Log data array
      const levels = new Set(response.data.data.map(member => member.levelName))
      memberLevels.value = Array.from(levels)
      console.log('Loaded levels:', memberLevels.value) // Debug log
    }
  } catch (error) {
    console.error('Error loading levels:', error)
  } finally {
    loading.value = false
  }
})

// Return all methods and refs that are used in template
const disabledDate = (current: dayjs.Dayjs) => {
  return current && current > dayjs().endOf('day')
}

// Thêm watch để theo dõi thay đổi
watch(memberLevels, (newValue) => {
  console.log('memberLevels changed:', newValue)
}, { deep: true })

// Export all necessary methods and refs
defineExpose({
  dateRange,
  filters,
  websites,
  memberLevels,
  months,
  handleWebsiteChange,
  handleFilter,
  handleReset,
  disabledDate,
  onDateRangeChange
})
</script> 